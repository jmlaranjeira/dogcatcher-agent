version: "3.9"

services:
  agent:
    build:
      context: .
      dockerfile: Dockerfile
    image: datadog-llm-jira-agent:latest
    container_name: datadog-llm-jira-agent
    restart: unless-stopped

    # Load your credentials and configuration (DO NOT bake them into the image)
    env_file:
      - .env

    # Volume is used to store cache and audit logs
    volumes:
      - ./_agent_cache:/app/.agent_cache

    # Command by default: you can override it for real/dry-run
    # Example commands:
    command: ["python","main.py","--real","--env","prod","--service","myservice","--hours","48","--limit","100","--max-tickets","5"]
    # command: ["python","main.py","--dry-run","--env","dev","--service","myservice","--hours","24","--limit","50"]
    # command: ["python","main.py","--dry-run","--env","dev","--service","myservice","--hours","24","--limit","50"]

    # Resources (Optional)
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 1G
  patchy:
    build:
      context: .
      dockerfile: Dockerfile
    image: patchy-agent:latest
    container_name: patchy-agent
    restart: "no"
    environment:
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - PATCHY_WORKSPACE=/workspace
      - REPAIR_ALLOWED_SERVICES=${REPAIR_ALLOWED_SERVICES}
      - REPAIR_MAX_PRS_PER_RUN=${REPAIR_MAX_PRS_PER_RUN:-1}
    volumes:
      - ./_patchy_workspace:/workspace
      - ./_agent_cache:/app/.agent_cache
    command: ["python","-m","patchy.patchy_graph","--service","myservice","--error-type","npe","--loghash","4c452e2d1c49","--draft","true"]
